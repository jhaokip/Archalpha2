################### Create BTRFS Subvolumes ######################################
# This function creates btrfs subvolumes necessary to make Snapper work properly
###################################################################################
source cosmetics
source UUID.txt

function create_subvolumes () 
{

	info_print "Mount the root BTRFS partition..."
	sudo mount UUID="$ROOT_UUID" /mnt
	sudo mount | grep mnt
	info_print "Create /mnt/@ subvolume..."
	sudo btrfs subvolume create /mnt/@
	info_print "Create /mnt/@/.snapsh"
	sudo btrfs subvolume create /mnt/@/.snapshots
    info_print "Create /mnt/@ subvolume..."
    sudo mkdir /mnt/@/.snapshots/1 > log.txt
	sudo btrfs subvolume create /mnt/@/.snapshots/1/snapshot >> log.txt
	sudo mkdir /mnt/@/boot >> log.txt
	sudo btrfs subvolume create /mnt/@/boot/grub >> log.txt
	sudo btrfs subvolume create /mnt/@/opt >> log.txt
	sudo btrfs subvolume create /mnt/@/root >> log.txt
	sudo btrfs subvolume create /mnt/@/srv >> log.txt
	sudo btrfs subvolume create /mnt/@/tmp >> log.txt
	sudo mkdir /mnt/@/usr >> log.txt
	sudo btrfs subvolume create /mnt/@/usr/local >> log.txt
	sudo mkdir /mnt/@/var >> log.txt
	sudo btrfs subvolume create /mnt/@/var/cache >> log.txt
	sudo btrfs subvolume create /mnt/@/var/log >> log.txt
	sudo btrfs subvolume create /mnt/@/var/spool >> log.txt
	sudo btrfs subvolume create /mnt/@/var/tmp >> log.txt
    info_print "Creating info.xml file"
	Date=$(date +"%Y-%m-%d %H:%M:%S")
	sed -i "s|temp|$Date|g" info.xml	
	sudo cp info.xml /mnt/@/.snapshots/1/

    info_print "Set default subvolume..."
	sudo btrfs subvolume set-default $(btrfs subvolume list /mnt | grep "@/.snapshots/1/snapshot" | grep -oP '(?<=ID )[0-9]+') /mnt

	sudo btrfs quota enable /mnt
	sudo chattr +C /mnt/@/var/cache
	sudo chattr +C /mnt/@/var/log
	sudo chattr +C /mnt/@/var/spool
	sudo chattr +C /mnt/@/var/tmp
	
	info_print "Created  subvolumes on /mnt: (sudo btrfs subvolume list /mnt)"
	sudo btrfs subvolume list /mnt
	sudo umount /mnt
}
